configVersion: 1
project: integration-testing
deploy:
 helmRelease: "[[ project ]]-[[ env ]]"
 namespace: "[[ env ]]"
---
image: test
from: golang:stretch
docker:
  WORKDIR: /app
  ENV:
    LC_ALL: en_US.UTF-8
    TZ: Europe/Moscow
mount:
- from: build_dir
  to: /var/cache/apt/
- from: tmp_dir
  to: /var/lib/apt/lists
git:
- add: /
  to: /app
  excludePaths:
  - .werffiles
  - .helm
  stageDependencies:
    install:
      - "**/*"
- add: /.werffiles/start_full.sh
  to: /start_full.sh
- add: /.werffiles/start_simple.sh
  to: /start_simple.sh
ansible:
  install:
  - name: Install essential utils
    apt:
      update_cache: yes
      name:
      - tzdata
      - locales
      - gnupg
      - bash
  - name: "Generate en_US.UTF-8 default locale"
    locale_gen:
      name: en_US.UTF-8
      state: present
  - name: Set timezone
    timezone:
      name: "Europe/Moscow"
  setup:
  - name: "Private repo git hack"
    shell: git config --global url.https://{{ env "RUNNER_GIT_ACCESS_USER" }}:{{ env "RUNNER_GIT_ACCESS_TOKEN" }}@lab.siroccotechnology.ru.insteadOf https://lab.siroccotechnology.ru
  - name: "Change rights for scripts"
    file:
      path: "{{`{{ item }}`}}"
      mode: a+x
    with_items:
      - /start_full.sh
      - /start_simple.sh